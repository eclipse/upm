version: '2'

services:

  main:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - http_proxy
        - https_proxy
        - no_proxy
        - BUILDDOC=OFF
        - BUILDSWIGPYTHON=OFF
        - BUILDSWIGJAVA=OFF
        - BUILDSWIGNODE=OFF
        - BUILDEXAMPLES=OFF
        - IPK=OFF
        - RPM=OFF
        - NPM=OFF
        - BUILDTESTS=ON
        - CC=clang-3.8
        - CXX=clang++-3.8
        - NODE_VERSION=v4.1.2
        - WERROR=ON
    environment:
      - http_proxy
      - https_proxy
      - no_proxy

  doc:
    extends: main
    build:
      args:
        - BUILDDOC=ON
    command: make doc

  examples:
    extends: main
    build:
      args:
        - BUILDEXAMPLES=ON
    command: bash -c "make $$(make help | grep example | sed 's/... //' | tr '\n' ' ')"

  python2:
    extends: main
    build:
      args:
        - BUILDSWIGPYTHON=ON
    command: bash -c "make $$(make help | grep _pyupm_.*-python2 | sed 's/... //' | tr '\n' ' ') && make test"

  python3:
    extends: python2
    command: bash -c "make $$(make help | grep _pyupm_.*-python3 | sed 's/... //' | tr '\n' ' ') && make test"

  java:
    extends: main
    build:
      args:
        - BUILDSWIGJAVA=ON
        - CC=gcc-4.8
        - CXX=g++-4.8
    command: bash -c "make $$(make help | grep javaupm | sed 's/... //' | tr '\n' ' ') && make test"

  node4:
    extends: main
    build:
      args:
        - BUILDSWIGNODE=ON
        - NODE_VERSION=v4.1.2
    command: bash -c "make $$(make help | grep jsupm | sed 's/... //' | tr '\n' ' ') && make test"

  node5:
    extends: node4
    build:
      args:
        - NODE_VERSION=v5.12.0
